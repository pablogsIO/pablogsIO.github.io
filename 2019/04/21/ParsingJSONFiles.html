<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name = "viewport" content = "width = 1200">
	<link href='https://fonts.googleapis.com/css?family=PT+Sans+Caption:400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/styles.css" />
	<link rel="stylesheet" href="/highlightswift.css" />
	<title>Pablo Apps - Apps for iPhone, iPad and Apple TV</title>
</head>

<body>
	<div id="wrapper">
	<header>
	

<table>
    <tr>
        <td class="d1">
            <hgroup>
				<h1><a href="/">Pablo Garcia</a></h1>
				<h2>Apps for iPhone, iPad, Apple TV and Apple Watch</h2>
			</hgroup>
        </td>
        
        <td class="d3">
			<nav>
				<ul>
					<li><a href="/">Home</a></li>
					<li><a href="/blog/">Blog</a></li>
					<li><a href="/contact/">Contact</a></li>
				</ul>
				
			</nav>
        </td>
        
    </tr>
</table>

</header>

	
		
    <div id="content">
    	<div id="post">
    		<article>
                <div>
    			<header>
    				<h1>Parsing JSON files - Codable, A new hope</h1>
    				<time>April 21, 2019
                </time>
    			</header>

				<p>For a long time, I’ve been using <a href="https://github.com/SwiftyJSON/SwiftyJSON">swiftyjson</a> for parsing JSON files. It’s a great library and if you, at some point, have had to work with JSON files, I’m pretty sure you’ve used it, am I right?</p>

<p>But Apple in 2017 gave us an easy way to work with JSON files: <strong>Codable</strong>. Codable is a typealias for <strong>Decodable</strong> and <strong>Encodable</strong> protocols.</p>

<h3 id="simple-data">Simple data</h3>

<p>Let’s see it in action. This will be our JSON file, a music album information:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">{</span><span class="w">
 </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Love Over Gold"</span><span class="p">,</span><span class="w">
 </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warner Bros"</span><span class="p">,</span><span class="w">
 </span><span class="nl">"releaseDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1982-09-20T19:00:00Z"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>
<p>And this will be our representation in Swift of the JSON structure</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">struct</span> <span class="kt">Album</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">releaseDate</span><span class="p">:</span> <span class="kt">Date</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Album struct adopt the Codable protocol for encoding and decodign it.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="k">let</span> <span class="nv">json</span> <span class="o">=</span> <span class="s">"""
{
 "</span><span class="n">name</span><span class="s">": "</span><span class="kt">Love</span> <span class="kt">Over</span> <span class="kt">Gold</span><span class="s">",
 "</span><span class="n">label</span><span class="s">": "</span><span class="kt">Warner</span> <span class="kt">Bros</span><span class="s">",
 "</span><span class="n">releaseDate</span><span class="s">": "</span><span class="mi">1982</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">20</span><span class="kt">T19</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="kt">Z</span><span class="s">"
}
"""</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">using</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>


<span class="kd">struct</span> <span class="kt">Album</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">releaseDate</span><span class="p">:</span> <span class="kt">Date</span>
<span class="p">}</span>

<span class="c1">//Select our decoder and set the date decoding strategy to iso8601(https://en.wikipedia.org/wiki/ISO_8601)</span>
<span class="c1">//The decoder will do the conversion between the JSON and our Swift structure</span>
<span class="k">let</span> <span class="nv">decoder</span> <span class="o">=</span> <span class="kt">JSONDecoder</span><span class="p">()</span>

<span class="n">decoder</span><span class="o">.</span><span class="n">dateDecodingStrategy</span> <span class="o">=</span> <span class="o">.</span><span class="n">iso8601</span>

<span class="k">let</span> <span class="nv">album</span> <span class="o">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">Album</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">json</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">album</span><span class="p">)</span>

</code></pre></div></div>
<p>And the result is….</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="err">Album(name:</span><span class="w"> </span><span class="s2">"Love Over Gold"</span><span class="err">,</span><span class="w"> </span><span class="err">label:</span><span class="w"> </span><span class="s2">"Warner Bros"</span><span class="err">,</span><span class="w"> </span><span class="err">releaseDate:</span><span class="w"> </span><span class="mi">1982-09-20</span><span class="w"> </span><span class="mi">19</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="err">+</span><span class="mi">0000</span><span class="err">)</span><span class="w">

</span></code></pre></div></div>

<p>What have just happened here?</p>

<p>The Codable protocol, which is actually not one protocol, but two, Decodable and Encodable</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">typealias</span> <span class="kt">Codable</span> <span class="o">=</span> <span class="kt">Decodable</span> <span class="o">&amp;</span> <span class="kt">Encodable</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">Encodable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">to</span> <span class="nv">encoder</span><span class="p">:</span> <span class="kt">Encoder</span><span class="p">)</span> <span class="k">throws</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">Decodable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">from</span> <span class="nv">decoder</span><span class="p">:</span> <span class="kt">Decoder</span><span class="p">)</span> <span class="k">throws</span>
<span class="p">}</span>

</code></pre></div></div>

<p>The <a href="https://developer.apple.com/documentation/swift/decodable">Decodable</a> protocol say that we have to implement the init function, but we didn’t. So why this example has worked? because the Swift compiler has provided one for us, isn’t it cute?</p>

<h3 id="complex-data">Complex data</h3>

<p>Let’s complicate a little bit our JSON file.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">{</span><span class="w">
</span><span class="nl">"band"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dire Straits"</span><span class="p">,</span><span class="w">
</span><span class="nl">"album"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Love Over Gold"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Warner Bros"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"releaseDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1982-09-20T19:00:00Z"</span><span class="w">
    </span><span class="p">},</span><span class="w">
</span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.markknopfler.com"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<p>We have added the name of the band and the url. Decoding is pretty easy:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Foundation</span>

<span class="k">let</span> <span class="nv">json</span> <span class="o">=</span> <span class="s">"""
{
"</span><span class="n">band</span><span class="s">": "</span><span class="kt">Dire</span> <span class="kt">Straits</span><span class="s">",
"</span><span class="n">album</span><span class="s">": {
    "</span><span class="n">name</span><span class="s">": "</span><span class="kt">Love</span> <span class="kt">Over</span> <span class="kt">Gold</span><span class="s">",
    "</span><span class="n">label</span><span class="s">": "</span><span class="kt">Warner</span> <span class="kt">Bros</span><span class="s">",
    "</span><span class="n">releaseDate</span><span class="s">": "</span><span class="mi">1982</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">20</span><span class="kt">T19</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="kt">Z</span><span class="s">"
    },
"</span><span class="n">band_url</span><span class="s">": "</span><span class="nv">https</span><span class="p">:</span><span class="c1">//www.markknopfler.com"</span>
<span class="p">}</span>
<span class="s">""".data(using: .utf8)!
</span></code></pre></div></div>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">struct</span> <span class="kt">Album</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">releaseDate</span><span class="p">:</span> <span class="kt">Date</span>
<span class="p">}</span>
<span class="kd">struct</span> <span class="kt">Band</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">band</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">album</span><span class="p">:</span> <span class="kt">Album</span>
    <span class="k">let</span> <span class="nv">band_url</span><span class="p">:</span> <span class="kt">URL</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">decoder</span> <span class="o">=</span> <span class="kt">JSONDecoder</span><span class="p">()</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">dateDecodingStrategy</span> <span class="o">=</span> <span class="o">.</span><span class="n">iso8601</span>

<span class="k">let</span> <span class="nv">band</span> <span class="o">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">Band</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">json</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

</code></pre></div></div>

<p><strong>Result</strong>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="err">Band(band:</span><span class="w"> </span><span class="s2">"Dire Straits"</span><span class="err">,</span><span class="w"> </span><span class="err">album:</span><span class="w"> </span><span class="err">__lldb_expr_</span><span class="mi">29</span><span class="err">.Album(name:</span><span class="w"> </span><span class="s2">"Love Over Gold"</span><span class="err">,</span><span class="w"> </span><span class="err">label:</span><span class="w"> </span><span class="s2">"Warner Bros"</span><span class="err">,</span><span class="w"> </span><span class="err">releaseDate:</span><span class="w"> </span><span class="mi">1982-09-20</span><span class="w"> </span><span class="mi">19</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="err">+</span><span class="mi">0000</span><span class="err">),</span><span class="w"> </span><span class="err">url:</span><span class="w"> </span><span class="err">https://www.markknopfler.com)</span><span class="w">

</span></code></pre></div></div>

<h3 id="properties-customization">Properties customization</h3>

<p>There’s one more thing that the compiler generated for us, and that is a private enum called CodingKeys. This enum adopt the <a href="https://developer.apple.com/documentation/swift/codingkey">CodingKey</a> protocol and is used by the decoder for encoding/decoding, if a property is not defined in this enum, will be ignored.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">private</span> <span class="kd">enum</span> <span class="kt">CodingKeys</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">CodingKey</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">band</span>
  <span class="k">case</span> <span class="n">album</span>
  <span class="k">case</span> <span class="n">band_url</span>
<span class="p">}</span>

</code></pre></div></div>

<p>The <strong>band_url</strong> property doesn’t match the Swift naming convention, so let’s do something about it. We will state that bandUrl property match with band_url.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">struct</span> <span class="kt">Band</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">band</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">album</span><span class="p">:</span> <span class="kt">Album</span>
    <span class="k">let</span> <span class="nv">bandUrl</span><span class="p">:</span> <span class="kt">URL</span>

    <span class="kd">private</span> <span class="kd">enum</span> <span class="kt">CodingKeys</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">CodingKey</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">band</span>
        <span class="k">case</span> <span class="n">album</span>
        <span class="k">case</span> <span class="n">bandUrl</span> <span class="o">=</span> <span class="s">"band_url"</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="decodable-customization">Decodable customization</h3>

<p>We have customized our properties, now, we’re going to customize the decodable by implementing init from decoder.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Foundation</span>

<span class="k">let</span> <span class="nv">json</span> <span class="o">=</span> <span class="s">"""
{
"</span><span class="n">band</span><span class="s">": "</span><span class="kt">Dire</span> <span class="kt">Straits</span><span class="s">",
"</span><span class="n">album</span><span class="s">": {
    "</span><span class="n">name</span><span class="s">": "</span><span class="kt">Love</span> <span class="kt">Over</span> <span class="kt">Gold</span><span class="s">",
    "</span><span class="n">label</span><span class="s">": "</span><span class="kt">Warner</span> <span class="kt">Bros</span><span class="s">",
    "</span><span class="n">releaseDate</span><span class="s">": "</span><span class="mi">1982</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">20</span><span class="kt">T21</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="kt">Z</span><span class="s">"
    },
"</span><span class="n">band_url</span><span class="s">": "</span><span class="nv">https</span><span class="p">:</span><span class="c1">//www.markknopfler.com"</span>
<span class="p">}</span>
<span class="s">""".data(using: .utf8)!
</span></code></pre></div></div>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Album</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">label</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">releaseDate</span><span class="p">:</span> <span class="kt">Date</span>
<span class="p">}</span>
<span class="kd">struct</span> <span class="kt">Band</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">band</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">album</span><span class="p">:</span> <span class="kt">Album</span>
    <span class="k">let</span> <span class="nv">bandUrl</span><span class="p">:</span> <span class="kt">URL</span>

    <span class="kd">private</span> <span class="kd">enum</span> <span class="kt">CodingKeys</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">CodingKey</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">band</span>
        <span class="k">case</span> <span class="n">album</span>
        <span class="k">case</span> <span class="n">bandUrl</span> <span class="o">=</span> <span class="s">"band_url"</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="n">from</span> <span class="nv">decoder</span><span class="p">:</span> <span class="kt">Decoder</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">container</span> <span class="o">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="o">.</span><span class="nf">container</span><span class="p">(</span><span class="nv">keyedBy</span><span class="p">:</span> <span class="kt">CodingKeys</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
        <span class="n">band</span> <span class="o">=</span> <span class="k">try</span> <span class="n">container</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">String</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="o">.</span><span class="n">band</span><span class="p">)</span>
        <span class="n">album</span> <span class="o">=</span> <span class="k">try</span> <span class="n">container</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">Album</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="o">.</span><span class="n">album</span><span class="p">)</span>
        <span class="n">bandUrl</span> <span class="o">=</span> <span class="k">try</span> <span class="n">container</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">URL</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="o">.</span><span class="n">bandUrl</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">decoder</span> <span class="o">=</span> <span class="kt">JSONDecoder</span><span class="p">()</span>
<span class="n">decoder</span><span class="o">.</span><span class="n">dateDecodingStrategy</span> <span class="o">=</span> <span class="o">.</span><span class="n">iso8601</span>

<span class="k">let</span> <span class="nv">band</span> <span class="o">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">Band</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">json</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="err">Band(band:</span><span class="w"> </span><span class="s2">"Dire Straits"</span><span class="err">,</span><span class="w"> </span><span class="err">album:</span><span class="w"> </span><span class="err">__lldb_expr_</span><span class="mi">19</span><span class="err">.Album(name:</span><span class="w"> </span><span class="s2">"Love Over Gold"</span><span class="err">,</span><span class="w"> </span><span class="err">label:</span><span class="w"> </span><span class="s2">"Warner Bros"</span><span class="err">,</span><span class="w"> </span><span class="err">releaseDate:</span><span class="w"> </span><span class="mi">1982-09-20</span><span class="w"> </span><span class="mi">21</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="err">+</span><span class="mi">0000</span><span class="err">),</span><span class="w"> </span><span class="err">bandUrl:</span><span class="w"> </span><span class="err">https://www.markknopfler.com)</span><span class="w">

</span></code></pre></div></div>

<h3 id="conclusion">Conclusion</h3>

<p>I think this is a pretty step forward and we should give Codable a try.</p>


                <div id="post-divider">
                    <section id="pagination">
                        
                        <a class="pagination-previous" href="/2019/05/10/Spritekit-BackgroundScroll.html">Spritekit - Background Scrolling - I &raquo</a>
                        
                        
                        <a class="pagination-next" href="/2019/03/31/MapClusteringIII.html">&laquo; Quadtree and Map Clustering - III </a>
                                
                    </section>
                </div>
            </div>

			</article>    
    	</div>

	</div>
    
	<footer>	
	<p>&copy; 2018 <a href="mailto:pablo@pablogs.io">Pablo Garcia. </a><a href="https://jekyllrb.com">Powered by Jekyll</a></p>
</footer>

</body>

</html>


