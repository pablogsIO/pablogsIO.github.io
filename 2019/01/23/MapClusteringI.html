<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name = "viewport" content = "width = 1200">
	<link href='https://fonts.googleapis.com/css?family=PT+Sans+Caption:400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/styles.css" />
	<link rel="stylesheet" href="/highlightswift.css" />
	<title>Pablo Apps - Apps for iPhone, iPad and Apple TV</title>
</head>

<body>
	<div id="wrapper">
	<header>
	

<table>
    <tr>
        <td class="d1">
            <hgroup>
				<h1><a href="/">Pablo Garcia</a></h1>
				<h2>Apps for iPhone, iPad, Apple TV and Apple Watch</h2>
			</hgroup>
        </td>
        
        <td class="d3">
			<nav>
				<ul>
					<li><a href="/">Home</a></li>
					<li><a href="/blog/">Blog</a></li>
					<li><a href="/contact/">Contact</a></li>
				</ul>
				
			</nav>
        </td>
        
    </tr>
</table>

</header>

	
		
    <div id="content">
    	<div id="post">
    		<article>
                <div>
    			<header>
    				<h1>Quadtree and Map Clustering - I</h1>
    				<time>January 23, 2019
                </time>
    			</header>

				<p>Nowadays, lot of apps use maps to show some information, great apps like <a href="https://itunes.apple.com/es/app/coffee-near-me/id683874335?mt=8">Starbucks Near Me</a>, <a href="https://itunes.apple.com/bz/app/luas-dublin/id1257004479?l=en&amp;mt=8">Luas Dublin</a> etc. But, what happen if there are a lot of annotations to show? probably we’d face up something like this.</p>

<p align="center">
  <img width="300" src="/images/posts/clustering/iPhone.png" />
</p>

<p>Really annoying, isn’t it? This map is crowded and it’s very difficult to get significant information from it.</p>

<p>One way to solve this problem is by grouping points that are at a certain distance from each other on the screen. At a low zoom levels (like the image shown above) we’ll show a few groups of points and at a high zoom levels more groups.</p>

<p align="center">
  <img width="300" src="/images/posts/clustering/low.png" />
  <img width="300" src="/images/posts/clustering/high.png" />
</p>

<p>This technique is called <strong>Clustering</strong>. Clustering is the task of grouping a set of objects in such a way that objects in the same group (called a cluster) are more similar (in some sense, i.e. distance) to each other than to those in other groups (clusters).</p>

<p>Basically this is a search problem, we’ll need to find all the points which lie in different regions of the map to create groups of points. QuadTree is a data structure that can efficiently find all locations contained in a specific region. It’s built by recursively subdividing a two-dimensional space into smaller regions.</p>

<h3 id="quadtree">QuadTree</h3>

<p>Each node of the QuadTree will have a list of points (in that node), the capacity and a bounding box. When we insert a new point in the QuadTree, first we check if the node’s bounding box contains the coordinates of the new point, if so, we check if the node is full. If not, we can insert the point, but if the node is full, we have to divide it in four small nodes and try to insert the point in each of this child nodes.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">class</span> <span class="kt">QuadTree</span> <span class="p">{</span>

    <span class="kd">static</span> <span class="k">let</span> <span class="nv">capacity</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">var</span> <span class="nv">points</span> <span class="o">=</span> <span class="p">[</span><span class="kt">CGPoint</span><span class="p">]()</span>
    <span class="k">var</span> <span class="nv">boundingBox</span> <span class="o">=</span> <span class="kt">CGRect</span><span class="p">()</span>
    <span class="k">var</span> <span class="nv">isDivided</span> <span class="o">=</span> <span class="kc">false</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">northWest</span><span class="p">:</span> <span class="kt">QuadTree</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">northEast</span><span class="p">:</span> <span class="kt">QuadTree</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">southWest</span><span class="p">:</span> <span class="kt">QuadTree</span><span class="p">?</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">southEast</span><span class="p">:</span> <span class="kt">QuadTree</span><span class="p">?</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">boundingBox</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span> <span class="o">=</span> <span class="n">boundingBox</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">insertPoint</span><span class="p">(</span><span class="nv">newPoint</span><span class="p">:</span> <span class="kt">CGPoint</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">guard</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">newPoint</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="kt">QuadTree</span><span class="o">.</span><span class="n">capacity</span> <span class="o">&amp;&amp;</span> <span class="n">northWest</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="n">points</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">newPoint</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">northWest</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="nf">subdivide</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">northWest</span><span class="p">?</span><span class="o">.</span><span class="nf">insertPoint</span><span class="p">(</span><span class="nv">newPoint</span><span class="p">:</span> <span class="n">newPoint</span><span class="p">)</span>
            <span class="n">northEast</span><span class="p">?</span><span class="o">.</span><span class="nf">insertPoint</span><span class="p">(</span><span class="nv">newPoint</span><span class="p">:</span> <span class="n">newPoint</span><span class="p">)</span>
            <span class="n">southWest</span><span class="p">?</span><span class="o">.</span><span class="nf">insertPoint</span><span class="p">(</span><span class="nv">newPoint</span><span class="p">:</span> <span class="n">newPoint</span><span class="p">)</span>
            <span class="n">southEast</span><span class="p">?</span><span class="o">.</span><span class="nf">insertPoint</span><span class="p">(</span><span class="nv">newPoint</span><span class="p">:</span> <span class="n">newPoint</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">subdivide</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">isDivided</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">let</span> <span class="nv">width</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">let</span> <span class="nv">height</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">let</span> <span class="nv">size</span> <span class="o">=</span> <span class="kt">CGSize</span><span class="p">(</span><span class="nv">width</span><span class="p">:</span> <span class="n">width</span><span class="o">-</span><span class="n">offset</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="n">height</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span>

        <span class="k">self</span><span class="o">.</span><span class="n">northWest</span> <span class="o">=</span> <span class="kt">QuadTree</span><span class="p">(</span><span class="nv">boundingBox</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">origin</span><span class="p">:</span> <span class="kt">CGPoint</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                                                      <span class="nv">y</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                                                      <span class="nv">size</span><span class="p">:</span> <span class="n">size</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="n">northEast</span> <span class="o">=</span> <span class="kt">QuadTree</span><span class="p">(</span><span class="nv">boundingBox</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">origin</span><span class="p">:</span> <span class="kt">CGPoint</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="o">+</span><span class="n">width</span><span class="p">,</span>
                                                                      <span class="nv">y</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                                                      <span class="nv">size</span><span class="p">:</span> <span class="n">size</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="n">southWest</span> <span class="o">=</span> <span class="kt">QuadTree</span><span class="p">(</span><span class="nv">boundingBox</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">origin</span><span class="p">:</span> <span class="kt">CGPoint</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                                                      <span class="nv">y</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span><span class="o">+</span><span class="n">height</span><span class="p">),</span>
                                                      <span class="nv">size</span><span class="p">:</span> <span class="n">size</span><span class="p">))</span>
        <span class="k">self</span><span class="o">.</span><span class="n">southEast</span> <span class="o">=</span> <span class="kt">QuadTree</span><span class="p">(</span><span class="nv">boundingBox</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">origin</span><span class="p">:</span> <span class="kt">CGPoint</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span><span class="o">+</span><span class="n">width</span><span class="p">,</span>
                                                                      <span class="nv">y</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">boundingBox</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span><span class="o">+</span><span class="n">height</span><span class="p">),</span>
                                                      <span class="nv">size</span><span class="p">:</span> <span class="n">size</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span>


</code></pre></div></div>

<p>Here you can see my QuadTree in action.</p>

<p align="center">
  <img width="500" src="/images/posts/clustering/quadtreeinsertion.gif" />

</p>

<p>See you in Quadtree and Map Clustering - II</p>


                <div id="post-divider">
                    <section id="pagination">
                        
                        <a class="pagination-previous" href="/2019/02/06/MapClusteringII.html">Quadtree and Map Clustering - II &raquo</a>
                        
                        
                        <a class="pagination-next" href="/2018/12/31/TutorialCollectionInsideTableView.html">&laquo; Tutorial - UICollectionView inside TableViewCell </a>
                                
                    </section>
                </div>
            </div>

			</article>    
    	</div>

	</div>
    
	<footer>	
	<p>&copy; 2018 <a href="mailto:pablo@pablogs.io">Pablo Garcia. </a><a href="https://jekyllrb.com">Powered by Jekyll</a></p>
</footer>

</body>

</html>


