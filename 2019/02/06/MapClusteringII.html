<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name = "viewport" content = "width = 1200">
	<link href='https://fonts.googleapis.com/css?family=PT+Sans+Caption:400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/styles.css" />
	<link rel="stylesheet" href="/highlightswift.css" />
	<title>Pablo Apps - Apps for iPhone, iPad and Apple TV</title>
</head>

<body>
	<div id="wrapper">
	<header>
	

<table>
    <tr>
        <td class="d1">
            <hgroup>
				<h1><a href="/">Pablo Garcia</a></h1>
				<h2>Apps for iPhone, iPad, Apple TV and Apple Watch</h2>
			</hgroup>
        </td>
        
        <td class="d3">
			<nav>
				<ul>
					<li><a href="/">Home</a></li>
					<li><a href="/blog/">Blog</a></li>
					<li><a href="/contact/">Contact</a></li>
				</ul>
				
			</nav>
        </td>
        
    </tr>
</table>

</header>

	
		
    <div id="content">
    	<div id="post">
    		<article>
                <div>
    			<header>
    				<h1>Quadtree and Map Clustering - II</h1>
    				<time>February 6, 2019
                </time>
    			</header>

				<p>In the previous post we viewed how to build a QuadTree, now we are going to do the real magic…</p>

<h2 id="clustering">Clustering</h2>

<p>Clustering is the task of grouping a set of objects in such a way that objects in the same group (called a cluster) are more similar (in some sense, i.e. distance) to each other than to those in other groups (clusters). We’ll need to find all the points which lie in different regions of the map to create groups of points.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">struct</span> <span class="kt">ClusterPoint</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">origin</span><span class="p">:</span> <span class="kt">CGPoint</span>
    <span class="k">let</span> <span class="nv">points</span><span class="p">:</span> <span class="kt">Int</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">PGClusteringManager</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">quadtree</span><span class="p">:</span> <span class="kt">QuadTree</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">boxWidth</span> <span class="o">=</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">boxHeight</span> <span class="o">=</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">quadtree</span><span class="p">:</span> <span class="kt">QuadTree</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">quadtree</span> <span class="o">=</span> <span class="n">quadtree</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">clusterAnnotationsWithinRectangle</span><span class="p">(</span><span class="nv">rectangle</span><span class="p">:</span> <span class="kt">CGRect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">ClusterPoint</span><span class="p">]</span> <span class="p">{</span>

        <span class="k">var</span> <span class="nv">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="kt">ClusterPoint</span><span class="p">]()</span>

        <span class="k">let</span> <span class="nv">boxArea</span> <span class="o">=</span> <span class="nf">calculateBoxAreaSize</span><span class="p">(</span><span class="nv">size</span><span class="p">:</span> <span class="n">rectangle</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">var</span> <span class="nv">xCoordinate</span> <span class="o">=</span> <span class="n">rectangle</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span>
        <span class="k">var</span> <span class="nv">yCoordinate</span> <span class="o">=</span> <span class="n">rectangle</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span>

        <span class="k">while</span> <span class="n">yCoordinate</span><span class="o">&lt;</span><span class="n">rectangle</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span> <span class="p">{</span>
            <span class="n">xCoordinate</span> <span class="o">=</span> <span class="n">rectangle</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span>
            <span class="k">while</span> <span class="n">xCoordinate</span><span class="o">&lt;</span><span class="n">rectangle</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">boundingBox</span> <span class="o">=</span> <span class="kt">CGRect</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="n">xCoordinate</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="n">yCoordinate</span><span class="p">,</span> <span class="nv">width</span><span class="p">:</span> <span class="n">boxArea</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="n">boxArea</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
                <span class="n">quadtree</span><span class="o">.</span><span class="nf">queryRegion</span><span class="p">(</span><span class="nv">rectangle</span><span class="p">:</span> <span class="n">boundingBox</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="k">in</span>
                    <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="k">var</span> <span class="nv">totalX</span> <span class="o">=</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">var</span> <span class="nv">totalY</span> <span class="o">=</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">point</span> <span class="k">in</span> <span class="n">points</span> <span class="p">{</span>
                            <span class="n">totalX</span> <span class="o">+=</span> <span class="n">point</span><span class="o">.</span><span class="n">x</span>
                            <span class="n">totalY</span> <span class="o">+=</span> <span class="n">point</span><span class="o">.</span><span class="n">y</span>
                        <span class="p">}</span>
                        <span class="k">let</span> <span class="nv">totalPoints</span> <span class="o">=</span> <span class="kt">CGFloat</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
                        <span class="n">clusters</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="kt">ClusterPoint</span><span class="p">(</span><span class="nv">origin</span><span class="p">:</span> <span class="kt">CGPoint</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="n">totalX</span><span class="o">/</span><span class="n">totalPoints</span><span class="p">,</span>
                                                                     <span class="nv">y</span><span class="p">:</span> <span class="n">totalY</span><span class="o">/</span><span class="n">totalPoints</span><span class="p">),</span>
                                                     <span class="nv">points</span><span class="p">:</span> <span class="n">points</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">xCoordinate</span> <span class="o">+=</span> <span class="n">boxArea</span><span class="o">.</span><span class="n">width</span>
            <span class="p">}</span>
            <span class="n">yCoordinate</span> <span class="o">+=</span> <span class="n">boxArea</span><span class="o">.</span><span class="n">height</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">clusters</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">calculateBoxAreaSize</span><span class="p">(</span><span class="nv">size</span><span class="p">:</span> <span class="kt">CGSize</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">CGSize</span> <span class="p">{</span>

        <span class="k">let</span> <span class="nv">width</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="n">boxWidth</span>
        <span class="k">let</span> <span class="nv">height</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="o">/</span><span class="n">boxHeight</span>

        <span class="k">return</span> <span class="kt">CGSize</span><span class="p">(</span><span class="nv">width</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span> <span class="nv">height</span><span class="p">:</span> <span class="n">height</span><span class="p">)</span>

    <span class="p">}</span>

<span class="p">}</span>


</code></pre></div></div>

<p>After insert all data in the QuadTree and calling the clusterAnnotationsWithinRectangle function, we’ll get something like this:</p>

<p align="center">
  <img width="500" src="/images/posts/clustering/clustering.png" />
</p>

<p>Awesome!! And now, we are going to check that everything is ok. In the next gift we can see all the points and cluster with their bounding box.</p>

<p align="center">
  <img width="500" src="/images/posts/clustering/clustering.gif" />
</p>


                <div id="post-divider">
                    <section id="pagination">
                        
                        
                        <a class="pagination-next" href="/2019/01/23/MapClusteringI.html">&laquo; Quadtree and Map Clustering - I </a>
                                
                    </section>
                </div>
            </div>

			</article>    
    	</div>

	</div>
    
	<footer>	
	<p>&copy; 2018 <a href="mailto:pablo@pablogs.io">Pablo Garcia. </a><a href="https://jekyllrb.com">Powered by Jekyll</a></p>
</footer>

</body>

</html>


